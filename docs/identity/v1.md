# TreeCRDT Identity v1 (Draft)

This repo’s sync/auth layers intentionally treat TreeCRDT as **ACL/E2EE-agnostic**. However, most real applications need:

- multi-device support (add a new device without losing access)
- key rotation and recovery (restore after reinstall)
- privacy across documents (doc A membership should not automatically reveal doc B membership)

Identity v1 is an **optional application-layer** design that supports these goals while keeping Sync v0 simple.

## Key layers

Identity v1 uses a 3-layer key hierarchy:

1) **Identity key** (global, stable)
   - Ed25519 keypair
   - Represents the account/user in the application
   - SHOULD NOT be disclosed in plaintext to the sync server by default (to avoid cross-doc linking)

2) **Device key** (per device)
   - Ed25519 keypair
   - Used to authorize device-local operations such as issuing doc replica keys
   - Can be rotated or revoked without changing the global identity key

3) **Replica key** (per document, per device)
   - Ed25519 keypair
   - The **public key is `replica_id`** in Sync v0 operations
   - This SHOULD be unique per `(doc_id, device)` to reduce linkability across docs

## Practical keystore (implemented here)

To make “per-doc keys, unlinkable by default” practical, this repo also implements a simple keystore format:

- **Device wrap key** (random 32 bytes): a symmetric key used only to *encrypt other secrets* at rest.
- **Per-doc sealed blobs** under the device wrap key:
  - a per-doc **doc key bundle** containing the **issuer key** (Ed25519, mints capability tokens) and **replica key** (Ed25519, signs ops)
  - (optional) a per-doc **payload key blob** (random 32 bytes) for E2EE payload encryption

Note: the reference implementation stores the doc key bundle and payload key as separate sealed blobs, but they are both
sealed under the same device wrap key.

This achieves:

- **Unlinkability by default**: different docs use different signing/issuer keys.
- **Future compatibility**: a later “master key” design can wrap/derive the device wrap key, without changing the per-doc bundle formats.

## Privacy model (cross-doc unlinkability)

- Sync v0 operations carry only `replica_id` (a 32-byte Ed25519 public key).
- If the application never sends **identity** or **device** keys/certificates over the sync channel, then an observer who learns you are in doc A cannot automatically link you to doc B.
- Linkability is introduced only if the application chooses to publish stable identifiers across docs (e.g. an `identity_pk` or a device/replica certificate chain) in a context visible to an observer.

## Certificates (optional)

Identity v1 defines two COSE_Sign1 certificates (Ed25519):

1) **DeviceCertV1**: `identity_sk` signs the device public key
2) **ReplicaCertV1**: `device_sk` signs a document-bound replica public key

These certs are meant for application workflows (recovery, multi-device, explicit linking), and are not required for baseline syncing.

This repo also includes an optional “identity chain” capability (`auth.identity_chain`) that can be exchanged between peers
to attribute signatures to a stable identity→device→replica chain. This is intentionally opt-in because it increases
linkability.

### Payload fields (reference)

DeviceCertV1 CBOR map:

- `v`: `1`
- `t`: `"treecrdt/device-cert/v1"`
- `device_pk`: 32-byte Ed25519 public key
- `iat` (optional): issued-at seconds
- `exp` (optional): expiry seconds

ReplicaCertV1 CBOR map:

- `v`: `1`
- `t`: `"treecrdt/replica-cert/v1"`
- `doc_id`: string
- `replica_pk`: 32-byte Ed25519 public key (this is `replica_id`)
- `iat` / `exp` (optional): seconds

## “Supabase as keychain” compatibility

This design is compatible with storing keys in a user account backend (e.g. Supabase):

- Supabase can store **encrypted** identity/device key material and per-doc sealed bundles (opaque blobs).
- Email login + server-side access control can provide the “key restore” UX.
- Whether Supabase can decrypt those keys depends on your application’s threat model; TreeCRDT does not require Supabase to see plaintext keys.

## Status

Draft / not wired into Sync v0 by default.
